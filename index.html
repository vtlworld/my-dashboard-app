<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VTL Dashboard</title>
    <style>
        /* --- CSS STYLES --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f6f8; color: #333; }
        
        /* App Bar */
        .app-bar { background-color: #1976d2; color: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; position: sticky; top: 0; z-index: 1000; }
        .app-bar h1 { margin: 0; font-size: 1.2rem; font-weight: 500; }

        /* Navigation Tabs */
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #ddd; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: 600; color: #666; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab.active { color: #1976d2; border-bottom: 3px solid #1976d2; background-color: #f0f7ff; }

        /* Container */
        .container { padding: 15px; max-width: 1000px; margin: 0 auto; padding-bottom: 60px; }

        /* Views */
        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }

        /* Cards & Inputs */
        .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        
        /* Buttons */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; color: white; }
        .btn-primary { background-color: #1976d2; }
        .btn-primary:hover { background-color: #115293; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Summary Boxes */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .summary-box { background: white; padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .summary-val { display: block; font-size: 1.2rem; font-weight: bold; color: #1976d2; }
        .summary-label { font-size: 0.8rem; color: #666; }

        /* Tables */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; color: #444; }
        tr:hover { background-color: #f9f9f9; }

        /* Loading Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1976d2; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Status Colors */
        .status-paid { color: green; font-weight: bold; }
        .status-debit { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="app-bar">
        <h1>VTL Manager</h1>
    </div>

    <div class="nav-tabs">
        <div class="tab active" onclick="switchTab('search')">üîç Search</div>
        <div class="tab" onclick="switchTab('inventory')">üì¶ Inventory</div>
    </div>

    <div id="loader" class="loader"></div>

    <div class="container">
        
        <div id="view-search" class="view active">
            <div class="card">
                <div class="form-group">
                    <label>Search Term</label>
                    <input type="text" id="searchTerm" placeholder="Enter Order ID, Part, etc.">
                </div>
                <div class="form-group">
                    <label>Search Field</label>
                    <select id="searchField">
                        <option value="All Fields">All Fields</option>
                        <option value="OrderID">Order ID</option>
                        <option value="Part">Part Code</option>
                        <option value="Payment_Status">Payment Status</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="runSearch()">SEARCH ORDERS</button>
            </div>

            <div id="searchSummary" class="summary-grid" style="display:none;">
                <div class="summary-box">
                    <span id="sumCount" class="summary-val">0</span>
                    <span class="summary-label">Orders Found</span>
                </div>
                <div class="summary-box">
                    <span id="sumValue" class="summary-val" style="color:green">0</span>
                    <span class="summary-label">Total Value</span>
                </div>
            </div>

            <div class="card" id="searchResultsCard" style="display:none;">
                <div class="table-responsive">
                    <table id="searchTable">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Part</th>
                                <th>Qty</th>
                                <th>Status</th>
                                <th>Net Payment</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="view">
            <div class="card">
                <div class="form-group">
                    <label>Select Month</label>
                    <select id="monthSelect">
                        <option value="">Loading months...</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadInventory()">REFRESH LEDGER</button>
            </div>

            <div class="card" id="inventoryResultCard" style="display:none;">
                <div class="table-responsive">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Part</th>
                                <th>Opening</th>
                                <th>Sold</th>
                                <th>Closing</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzklJTtTVOjDhB0MOxlsxeCiEw0EX-vVvSIC7bOBJuI80jRRXfYleWpuSgaCiedPCkh/exec";

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            if (tabName === 'search') {
                document.querySelectorAll('.tab')[0].classList.add('active');
                document.getElementById('view-search').classList.add('active');
            } else {
                document.querySelectorAll('.tab')[1].classList.add('active');
                document.getElementById('view-inventory').classList.add('active');
                if (document.getElementById('monthSelect').options.length <= 1) {
                    loadMonths(); // Auto load months if not loaded
                }
            }
        }

        // --- UTILS ---
        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // --- SEARCH FUNCTIONS ---
        function runSearch() {
            const term = document.getElementById('searchTerm').value;
            const field = document.getElementById('searchField').value;

            if (!term) return alert("Please enter a search term.");

            toggleLoader(true);
            document.getElementById('searchResultsCard').style.display = 'none';
            document.getElementById('searchSummary').style.display = 'none';

            fetch(`${API_URL}?action=search&term=${encodeURIComponent(term)}&field=${encodeURIComponent(field)}`)
                .then(res => res.json())
                .then(data => {
                    toggleLoader(false);
                    if (data.status === 'error') {
                        alert(data.message);
                        return;
                    }
                    renderSearchResults(data);
                })
                .catch(e => {
                    toggleLoader(false);
                    alert("Error: " + e.message);
                });
        }

        function renderSearchResults(data) {
            // Update Summary
            document.getElementById('sumCount').innerText = data.count;
            document.getElementById('sumValue').innerText = data.summaries.salesValue;
            document.getElementById('searchSummary').style.display = 'grid';

            // Update Table
            const tbody = document.querySelector('#searchTable tbody');
            tbody.innerHTML = '';
            
            if (data.rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No results found.</td></tr>';
            } else {
                data.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    // Color code status
                    let statusColor = '';
                    if(row.Payment_Status === 'Paid') statusColor = 'color:green; font-weight:bold';
                    else if(row.Payment_Status.includes('Debit')) statusColor = 'color:red; font-weight:bold';

                    tr.innerHTML = `
                        <td>${row.OrderID}</td>
                        <td>${row.Part}</td>
                        <td>${row.SalesQty}</td>
                        <td style="${statusColor}">${row.Payment_Status}</td>
                        <td>${row.Net_Payment}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('searchResultsCard').style.display = 'block';
        }

        // --- INVENTORY FUNCTIONS ---
        function loadMonths() {
            const select = document.getElementById('monthSelect');
            select.innerHTML = '<option>Loading...</option>';
            
            fetch(`${API_URL}?action=getInventoryMonths`)
                .then(res => res.json())
                .then(data => {
                    select.innerHTML = '';
                    if (data.months && data.months.length > 0) {
                        data.months.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.value;
                            opt.innerText = m.display;
                            select.appendChild(opt);
                        });
                    } else {
                        select.innerHTML = '<option value="">No data available</option>';
                    }
                });
        }

        function loadInventory() {
            const month = document.getElementById('monthSelect').value;
            if (!month) return alert("Please select a month.");

            toggleLoader(true);
            document.getElementById('inventoryResultCard').style.display = 'none';

            fetch(`${API_URL}?action=getInventory&month=${encodeURIComponent(month)}`)
                .then(res => res.json())
                .then(data => {
                    toggleLoader(false);
                    renderInventory(data.rows);
                })
                .catch(e => {
                    toggleLoader(false);
                    alert("Error: " + e.message);
                });
        }

        function renderInventory(rows) {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';

            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">No data for this month.</td></tr>';
            } else {
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold">${row.PartCode}</td>
                        <td>${row.OpeningStock}</td>
                        <td style="color:green">${row.OrderedQty}</td>
                        <td style="font-weight:bold">${row.ClosingStock}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('inventoryResultCard').style.display = 'block';
        }
    </script>
</body>
</html>
