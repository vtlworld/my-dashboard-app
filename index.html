<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>VTL Dashboard</title>
    
    <meta name="theme-color" content="#1976d2">
    <link rel="manifest" href="manifest.json">

    <style>
        /* --- GLOBAL STYLES --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f6f8; 
            color: #333; 
        }
        
        /* --- LAYOUT --- */
        .app-bar { 
            background-color: #1976d2; color: white; padding: 15px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            display: flex; align-items: center; justify-content: center; 
            position: sticky; top: 0; z-index: 1000; 
        }
        .app-bar h1 { margin: 0; font-size: 1.2rem; font-weight: 500; }
        .nav-tabs { 
            display: flex; background: white; 
            border-bottom: 1px solid #ddd; 
            overflow-x: auto; -webkit-overflow-scrolling: touch; 
        }
        .container { padding: 10px; max-width: 1000px; margin: 0 auto; padding-bottom: 60px; }
        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }

        /* --- COMPONENTS --- */
        .tab { 
            flex: 1; padding: 15px 10px; text-align: center; 
            cursor: pointer; font-weight: 600; color: #666; 
            border-bottom: 3px solid transparent; transition: 0.3s; 
            min-width: 80px; 
        }
        .tab.active { 
            color: #1976d2; 
            border-bottom: 3px solid #1976d2; 
            background-color: #f0f7ff; 
        }
        .card { 
            background: white; border-radius: 8px; 
            padding: 15px; margin-bottom: 15px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
        }
        .form-group { margin-bottom: 15px; }
        label { 
            display: block; margin-bottom: 5px; font-weight: bold; 
            font-size: 0.9rem; color: #555; 
        }
        input, select { 
            width: 100%; padding: 12px; border: 1px solid #ddd; 
            border-radius: 6px; font-size: 16px; box-sizing: border-box; 
        }
        .btn { 
            width: 100%; padding: 14px; border: none; border-radius: 6px; 
            font-size: 16px; font-weight: bold; cursor: pointer; 
            transition: 0.2s; color: white; 
        }
        .btn-primary { background-color: #1976d2; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Summary Grids */
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .summary-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .summary-box { background: white; padding: 12px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .summary-val { display: block; font-size: 1.2rem; font-weight: bold; color: #1976d2; }
        .summary-label { font-size: 0.8rem; color: #666; }

        /* Tables (Only for Inventory) */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; min-width: 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; color: #444; }
        
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1976d2; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ============================================================
        === CARD VIEW STYLES ===
        ============================================================
        */
        .result-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            margin-bottom: 12px;
        }
        .card-header {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
            display: block;
        }
        .card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        .card-row:last-child {
            border-bottom: none;
        }
        .card-label {
            color: #666;
        }
        .card-value {
            color: #111;
            font-weight: 500;
            text-align: right;
        }
        .card-value.status-paid { color: #28a745; font-weight: bold; }
        .card-value.status-debit { color: #dc3545; font-weight: bold; }
        .card-value.status-sellable { color: #28a745; font-weight: bold; }
        .card-value.status-unsellable { color: #fd7e14; font-weight: bold; }
        .card-value.status-fraud { color: #dc3545; font-weight: bold; }
        
        /* Mobile fixes */
        @media (max-width: 600px) {
            .summary-grid {
                grid-template-columns: 1fr; 
            }
            .summary-grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="app-bar">
        <h1>VTL Manager</h1>
    </div>

    <div class="nav-tabs">
        <div id="tab-search" class="tab active" onclick="switchTab('search')">üîç Search</div>
        <div id="tab-inventory" class="tab" onclick="switchTab('inventory')">üì¶ Inventory</div>
        <div id="tab-return" class="tab" onclick="switchTab('return')">‚Ü©Ô∏è Returns</div>
        <div id="tab-misplaced" class="tab" onclick="switchTab('misplaced')">‚ùì Misplaced</div>
        <div id="tab-claims" class="tab" onclick="switchTab('claims')">üõ°Ô∏è Claims</div>
        <div id="tab-payments" class="tab" onclick="switchTab('payments')">üí≥ Payments</div>
    </div>

    <div id="loader" class="loader"></div>

    <div class="container">
        
        <div id="view-search" class="view active">
            <div class="card">
                <div class="form-group">
                    <label>Search Term</label>
                    <input type="text" id="searchTerm" placeholder="Enter Order ID, Part, etc.">
                </div>
                <div class="form-group">
                    <label>Search Field</label>
                    <select id="searchField">
                        <option value="All Fields">All Fields</option>
                        <option value="OrderID">Order ID</option>
                        <option value="Part">Part Code</option>
                        <option value="Payment_Status">Payment Status</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="runSearch()">SEARCH ORDERS</button>
            </div>

            <div id="searchSummary" class="summary-grid" style="display:none;">
                <div class="summary-box">
                    <span id="sumCount" class="summary-val">0</span>
                    <span class="summary-label">Orders Found</span>
                </div>
                <div class="summary-box">
                    <span id="sumValue" class="summary-val" style="color:green">0</span>
                    <span class="summary-label">Total Value</span>
                </div>
            </div>

            <div id="searchResultsList">
                </div>
        </div>

        <div id="view-inventory" class="view">
            <div class="card">
                <div class="form-group">
                    <label>Select Month</label>
                    <select id="monthSelect">
                        <option value="">Loading months...</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="loadInventory()">REFRESH LEDGER</button>
            </div>

            <div class="card" id="inventoryResultCard" style="display:none;">
                <div class="table-responsive">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>Part</th>
                                <th>Opening</th>
                                <th>Sold</th>
                                <th>Closing</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="view-return" class="view">
            <div class="summary-grid-3">
                <div class="summary-box">
                    <span id="returnSellable" class="summary-val" style="color:#28a745">0</span>
                    <span class="summary-label">Sellable</span>
                </div>
                <div class="summary-box">
                    <span id="returnUnsellable" class="summary-val" style="color:#fd7e14">0</span>
                    <span class="summary-label">Unsellable</span>
                </div>
                <div class="summary-box">
                    <span id="returnFraud" class="summary-val" style="color:#dc3545">0</span>
                    <span class="summary-label">Fraud</span>
                </div>
            </div>
            <div id="returnList">
                </div>
        </div>
        
        <div id="view-misplaced" class="view">
            <div class="card">
                <h2>Misplaced Dashboard</h2>
                <p>This tab will show data on misplaced items.</p>
            </div>
        </div>
        
        <div id="view-claims" class="view">
            <div class="card">
                <h2>Safety Claims Dashboard</h2>
                <p>This tab will show all safety claim data.</p>
            </div>
        </div>
        
        <div id="view-payments" class="view">
            <div class="card">
                <h2>Payments Dashboard</h2>
                <p>This tab will show a summary of all payments.</p>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbzklJTtTVOjDhB0MOxlsxeCiEw0EX-vVvSIC7bOBJuI80jRRXfYleWpuSgaCiedPCkh/exec";
        
        // --- STATE ---
        const appState = {
            inventoryMonthsLoaded: false,
            returnsLoaded: false
        };

        // --- TABS ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            
            document.getElementById('tab-' + tabName).classList.add('active');
            document.getElementById('view-' + tabName).classList.add('active');
            
            // --- Auto-load data for new tabs ---
            if (tabName === 'inventory' && !appState.inventoryMonthsLoaded) {
                loadMonths(); 
            }
            if (tabName === 'return' && !appState.returnsLoaded) {
                loadReturns();
            }
        }

        // --- UTILS ---
        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        // --- SEARCH FUNCTIONS (NOW RENDERS CARDS) ---
        function runSearch() {
            const term = document.getElementById('searchTerm').value;
            const field = document.getElementById('searchField').value;
            if (!term) return alert("Please enter a search term.");

            toggleLoader(true);
            document.getElementById('searchResultsList').style.display = 'none';
            document.getElementById('searchSummary').style.display = 'none';

            fetch(`${API_URL}?action=search&term=${encodeURIComponent(term)}&field=${encodeURIComponent(field)}`)
                .then(res => res.json())
                .then(data => {
                    toggleLoader(false);
                    if (data.status === 'error') {
                        alert(data.message);
                        return;
                    }
                    renderSearchResults(data);
                })
                .catch(e => {
                    toggleLoader(false);
                    alert("Error: " + e.message);
                });
        }

        function renderSearchResults(data) {
            document.getElementById('sumCount').innerText = data.count;
            document.getElementById('sumValue').innerText = data.summaries.salesValue;
            document.getElementById('searchSummary').style.display = 'grid';

            const list = document.getElementById('searchResultsList');
            list.innerHTML = ''; // Clear old results
            
            if (data.rows.length === 0) {
                list.innerHTML = '<p style="text-align:center">No results found.</p>';
            } else {
                data.rows.forEach(row => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    
                    let statusColor = '';
                    if(row.Payment_Status === 'Paid') statusColor = 'status-paid';
                    else if(row.Payment_Status.includes('Debit')) statusColor = 'status-debit';

                    card.innerHTML = `
                        <span class="card-header">${row.OrderID}</span>
                        <div class="card-row">
                            <span class="card-label">Part</span>
                            <span class="card-value">${row.Part}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Qty</span>
                            <span class="card-value">${row.SalesQty}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Payment Status</span>
                            <span class="card-value ${statusColor}">${row.Payment_Status}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Net Payment</span>
                            <span class="card-value ${statusColor}">${row.Net_Payment}</span>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }
            list.style.display = 'block';
        }

        // --- INVENTORY FUNCTIONS (Unchanged) ---
        function loadMonths() {
            toggleLoader(true);
            const select = document.getElementById('monthSelect');
            select.innerHTML = '<option>Loading...</option>';
            
            fetch(`${API_URL}?action=getInventoryMonths`)
                .then(res => res.json())
                .then(data => {
                    toggleLoader(false);
                    select.innerHTML = '';
                    if (data.months && data.months.length > 0) {
                        data.months.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.value;
                            opt.innerText = m.display;
                            select.appendChild(opt);
                        });
                        appState.inventoryMonthsLoaded = true;
                    } else {
                        select.innerHTML = '<option value="">No data available</option>';
                    }
                });
        }

        function loadInventory() {
            const month = document.getElementById('monthSelect').value;
            if (!month) return alert("Please select a month.");

            toggleLoader(true);
            document.getElementById('inventoryResultCard').style.display = 'none';

            fetch(`${API_URL}?action=getInventory&month=${encodeURIComponent(month)}`)
                .then(res => res.json())
                .then(data => {
                    toggleLoader(false);
                    renderInventory(data.rows);
                })
                .catch(e => {
                    toggleLoader(false);
                    alert("Error: " + e.message);
                });
        }

        function renderInventory(rows) {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';
            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center">No data for this month.</td></tr>';
            } else {
                rows.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-weight:bold">${row.PartCode}</td>
                        <td>${row.OpeningStock}</td>
                        <td style="color:green">${row.OrderedQty}</td>
                        <td style="font-weight:bold">${row.ClosingStock}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            document.getElementById('inventoryResultCard').style.display = 'block';
        }

        // --- RETURN FUNCTIONS (NOW RENDERS CARDS) ---
        function loadReturns() {
            toggleLoader(true);
            appState.returnsLoaded = true; // Mark as "loading"
            
            fetch(`${API_URL}?action=getReturns`)
                .then(res => res.json())
                .then(data => {
                    toggleLoader(false);
                    if (data.status === 'error') {
                        alert(data.message);
                        return;
                    }
                    renderReturns(data);
                })
                .catch(e => {
                    toggleLoader(false);
                    alert("Error: " + e.message);
                });
        }

        function renderReturns(data) {
            // Update Summary (THIS IS THE LINE I FIXED)
            document.getElementById('returnSellable').innerText = data.summaries.totalSellable;
            document.getElementById('returnUnsellable').innerText = data.summaries.totalUnsellable;
            document.getElementById('returnFraud').innerText = data.summaries.totalFraud;
            
            const list = document.getElementById('returnList');
            list.innerHTML = ''; // Clear old results
            
            if (data.rows.length === 0) {
                list.innerHTML = '<p style="text-align:center">No returns found.</p>';
            } else {
                data.rows.forEach(row => {
                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <span class="card-header">${row.OrderID}</span>
                        <div class="card-row">
                            <span class="card-label">Part</span>
                            <span class="card-value">${row.Part}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Return Date</span>
                            <span class="card-value">${new Date(row.ReturnDate).toLocaleDateString()}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Sellable</span>
                            <span class="card-value status-sellable">${row.Sellable}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Unsellable</span>
                            <span class="card-value status-unsellable">${row.Unsellable}</span>
                        </div>
                        <div class="card-row">
                            <span class="card-label">Fraud</span>
                            <span class="card-value status-fraud">${row.Fraud}</span>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }
        }
        
        // --- PWA REGISTRATION SCRIPT ---
        if ('serviceWorker' in navigator) {
          window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
              .then(registration => {
                console.log('ServiceWorker registration successful');
              })
              .catch(err => {
                console.log('ServiceWorker registration failed: ', err);
              });
          });
        }
    </script>
</body>
</html>
